<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Don't quit, you deserve what you want."><title>Dive into flask: journey of one request | JOHOO'S BLOG</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Dive into flask: journey of one request</h1><a id="logo" href="/.">JOHOO'S BLOG</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Dive into flask: journey of one request</h1><div class="post-meta"><a href="/2018/11/30/Dive-into-flask-the-journey-of-one-request/#comments" class="comment-count"><i data-disqus-identifier="2018/11/30/Dive-into-flask-the-journey-of-one-request/" class="disqus-comment-count"></i>Guestbook</a><p><span class="date">Nov 30, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><p>一直对Flask的实现机制很好奇，本着知其然更要知其所以然的态度，我将基于一个简单的HTTP请求来分析分析Flask的源码，看看是如何从请求变成响应的。</p>
<p>Flask是基于WSGI协议实现的Python Web开发框架，我不会介绍什么是WSGI协议，请看: <a href="https://www.python.org/dev/peps/pep-3333/" target="_blank" rel="noopener">https://www.python.org/dev/peps/pep-3333/</a></p>
<p>一个典型的flask application如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello &#123;&#125;"</span>.format(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hi')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hi~'</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>基本过程如下：</p>
<ol>
<li>创建Flask类的实例，即app这个应用；</li>
<li>用app.route装饰器来构建url映射；</li>
<li>收到请求，确定对应的视图函数，调用视图函数得到响应并返回给服务器，而后再由服务器返回给客户端，一次请求结束。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
<p><strong>以上这一步做了什么？</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#: The class that is used for request objects.  See :class:`~flask.Request`</span></span><br><span class="line">    <span class="comment">#: for more information.</span></span><br><span class="line">    request_class = Request</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: The class that is used for response objects.  See</span></span><br><span class="line">    <span class="comment">#: :class:`~flask.Response` for more information.</span></span><br><span class="line">    response_class = Response</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: The rule object to use for URL rules created.  This is used by</span></span><br><span class="line">    <span class="comment">#: :meth:`add_url_rule`.  Defaults to :class:`werkzeug.routing.Rule`.</span></span><br><span class="line">    <span class="comment">#:</span></span><br><span class="line">    <span class="comment">#: .. versionadded:: 0.7</span></span><br><span class="line">    url_rule_class = Rule</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        import_name,</span></span></span><br><span class="line"><span class="function"><span class="params">        static_url_path=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        static_folder=<span class="string">'static'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        static_host=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        host_matching=False,</span></span></span><br><span class="line"><span class="function"><span class="params">        subdomain_matching=False,</span></span></span><br><span class="line"><span class="function"><span class="params">        template_folder=<span class="string">'templates'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        instance_path=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        instance_relative_config=False,</span></span></span><br><span class="line"><span class="function"><span class="params">        root_path=None</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line">        _PackageBoundObject.__init__(</span><br><span class="line">            self,</span><br><span class="line">            import_name,</span><br><span class="line">            template_folder=template_folder,</span><br><span class="line">            root_path=root_path</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">	    ......</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#: A dictionary of all view functions registered.  The keys will</span></span><br><span class="line">        <span class="comment">#: be function names which are also used to generate URLs and</span></span><br><span class="line">        <span class="comment">#: the values are the function objects themselves.</span></span><br><span class="line">        <span class="comment">#: To register a view function, use the :meth:`route` decorator.</span></span><br><span class="line">        self.view_functions = &#123;&#125;</span><br><span class="line">        <span class="comment">#: A dictionary with lists of functions that will be called at the</span></span><br><span class="line">        <span class="comment">#: beginning of each request. The key of the dictionary is the name of</span></span><br><span class="line">        <span class="comment">#: the blueprint this function is active for, or ``None`` for all</span></span><br><span class="line">        <span class="comment">#: requests. To register a function, use the :meth:`before_request`</span></span><br><span class="line">        <span class="comment">#: decorator.</span></span><br><span class="line">        self.before_request_funcs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: A list of functions that will be called at the beginning of the</span></span><br><span class="line">        <span class="comment">#: first request to this instance. To register a function, use the</span></span><br><span class="line">        <span class="comment">#: :meth:`before_first_request` decorator.</span></span><br><span class="line">        <span class="comment">#:</span></span><br><span class="line">        <span class="comment">#: .. versionadded:: 0.8</span></span><br><span class="line">        self.before_first_request_funcs = []</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: A dictionary with lists of functions that should be called after</span></span><br><span class="line">        <span class="comment">#: each request.  The key of the dictionary is the name of the blueprint</span></span><br><span class="line">        <span class="comment">#: this function is active for, ``None`` for all requests.  This can for</span></span><br><span class="line">        <span class="comment">#: example be used to close database connections. To register a function</span></span><br><span class="line">        <span class="comment">#: here, use the :meth:`after_request` decorator.</span></span><br><span class="line">        self.after_request_funcs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: The :class:`~werkzeug.routing.Map` for this instance.  You can use</span></span><br><span class="line">        <span class="comment">#: this to change the routing converters after the class was created</span></span><br><span class="line">        <span class="comment">#: but before any routes are connected.  Example::</span></span><br><span class="line">        <span class="comment">#:</span></span><br><span class="line">        <span class="comment">#:    from werkzeug.routing import BaseConverter</span></span><br><span class="line">        <span class="comment">#:</span></span><br><span class="line">        <span class="comment">#:    class ListConverter(BaseConverter):</span></span><br><span class="line">        <span class="comment">#:        def to_python(self, value):</span></span><br><span class="line">        <span class="comment">#:            return value.split(',')</span></span><br><span class="line">        <span class="comment">#:        def to_url(self, values):</span></span><br><span class="line">        <span class="comment">#:            return ','.join(super(ListConverter, self).to_url(value)</span></span><br><span class="line">        <span class="comment">#:                            for value in values)</span></span><br><span class="line">        <span class="comment">#:</span></span><br><span class="line">        <span class="comment">#:    app = Flask(__name__)</span></span><br><span class="line">        <span class="comment">#:    app.url_map.converters['list'] = ListConverter</span></span><br><span class="line">        self.url_map = Map()</span><br></pre></td></tr></table></figure>
<p>实际做的东西还有很多，我只把其中关键的一些拎出来了 。</p>
<p>我们传入给flask.Flask的<code>__name__</code>作为import_name, 其作用是定义app的默认root_path, 用来为一系列配置资源定位。</p>
<p>flask.Flask定义了很多东西：</p>
<ul>
<li>request_class: 请求类</li>
<li>response_class: 响应类</li>
<li>url_rule_class: URL规则类</li>
<li>self.view_functions: 映射 端点<->视图函数 的字典</-></li>
<li>self.before_request_funcs: 存放每次请求前要执行的函数</li>
<li>self.before_first_request_funcs:  存放一系列在app的第一个请求之前需要执行的函数</li>
<li>self.after_request_funcs: 存放每次请求后要执行的函数</li>
<li>self.url_map: 规则的映射类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello &#123;&#125;"</span>.format(name)</span><br></pre></td></tr></table></figure>
<p><strong>这一步又做了什么？</strong></p>
<p>用app.route这个带参数的装饰器来修饰index函数。app.route的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask/app.py</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></span><br><span class="line">        <span class="string">"""A decorator that is used to register a view function for a</span></span><br><span class="line"><span class="string">        given URL rule.  This does the same thing as :meth:`add_url_rule`</span></span><br><span class="line"><span class="string">        but is intended for decorator usage::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            @app.route('/')</span></span><br><span class="line"><span class="string">            def index():</span></span><br><span class="line"><span class="string">                return 'Hello World'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        For more information refer to :ref:`url-route-registrations`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param rule: the URL rule as string</span></span><br><span class="line"><span class="string">        :param endpoint: the endpoint for the registered URL rule.  Flask</span></span><br><span class="line"><span class="string">                         itself assumes the name of the view function as</span></span><br><span class="line"><span class="string">                         endpoint</span></span><br><span class="line"><span class="string">        :param options: the options to be forwarded to the underlying</span></span><br><span class="line"><span class="string">                        :class:`~werkzeug.routing.Rule` object.  A change</span></span><br><span class="line"><span class="string">                        to Werkzeug is handling of method options.  methods</span></span><br><span class="line"><span class="string">                        is a list of methods this rule should be limited</span></span><br><span class="line"><span class="string">                        to (``GET``, ``POST`` etc.).  By default a rule</span></span><br><span class="line"><span class="string">                        just listens for ``GET`` (and implicitly ``HEAD``).</span></span><br><span class="line"><span class="string">                        Starting with Flask 0.6, ``OPTIONS`` is implicitly</span></span><br><span class="line"><span class="string">                        added and handled by the standard request handling.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">            endpoint = options.pop(<span class="string">'endpoint'</span>, <span class="keyword">None</span>)</span><br><span class="line">            self.add_url_rule(rule, endpoint, f, **options)</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>
<p>decorator内调用add_url_rule方法，并原样返回f, 因此路由函数没有任何改变。那么add_url_rule做了什么呢？看看它的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint=None, view_func=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                   provide_automatic_options=None, **options)</span>:</span></span><br><span class="line">      <span class="keyword">if</span> endpoint <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">          endpoint = _endpoint_from_view_func(view_func)</span><br><span class="line">      options[<span class="string">'endpoint'</span>] = endpoint</span><br><span class="line">      methods = options.pop(<span class="string">'methods'</span>, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># if the methods are not given and the view_func object knows its</span></span><br><span class="line">      <span class="comment"># methods we can use that instead.  If neither exists, we go with</span></span><br><span class="line">      <span class="comment"># a tuple of only ``GET`` as default.</span></span><br><span class="line">      <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">          methods = getattr(view_func, <span class="string">'methods'</span>, <span class="keyword">None</span>) <span class="keyword">or</span> (<span class="string">'GET'</span>,)</span><br><span class="line">      <span class="keyword">if</span> isinstance(methods, string_types):</span><br><span class="line">          <span class="keyword">raise</span> TypeError(<span class="string">'Allowed methods have to be iterables of strings, '</span></span><br><span class="line">                          <span class="string">'for example: @app.route(..., methods=["POST"])'</span>)</span><br><span class="line">      methods = set(item.upper() <span class="keyword">for</span> item <span class="keyword">in</span> methods)</span><br><span class="line">......</span><br><span class="line">      rule = self.url_rule_class(rule, methods=methods, **options)</span><br><span class="line">      rule.provide_automatic_options = provide_automatic_options</span><br><span class="line"></span><br><span class="line">      self.url_map.add(rule)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">          old_func = self.view_functions.get(endpoint)</span><br><span class="line">          <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">              <span class="keyword">raise</span> AssertionError(<span class="string">'View function mapping is overwriting an '</span></span><br><span class="line">                                   <span class="string">'existing endpoint function: %s'</span> % endpoint)</span><br><span class="line">          self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure>
<p>先确定<code>endpoint</code>和<code>methods</code>, 然后构建werkzeug/routing.Rule类的实例rule, 并以rule为参数调用<code>self.url_map</code>的add方法，之后就是简单的在<code>self.view_functions</code>字典中以<code>endpoint</code>为键，<code>view_func</code>为值建立映射。关键的地方就这两步了:</p>
<ul>
<li>构建werkzeug/routing.Rule类的实例rule</li>
<li>以rule为参数调用<code>self.url_map</code>的add方法</li>
</ul>
<p>werkzeug/routing.Rule的构造函数是这样的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rule</span><span class="params">(RuleFactory)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, string, defaults=None, subdomain=None, methods=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 build_only=False, endpoint=None, strict_slashes=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 redirect_to=None, alias=False, host=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> string.startswith(<span class="string">'/'</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'urls must start with a leading slash'</span>)</span><br><span class="line">        self.rule = string</span><br><span class="line">        self.is_leaf = <span class="keyword">not</span> string.endswith(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">        self.map = <span class="keyword">None</span></span><br><span class="line">        self.strict_slashes = strict_slashes</span><br><span class="line">        self.subdomain = subdomain</span><br><span class="line">        self.host = host</span><br><span class="line">        self.defaults = defaults</span><br><span class="line">        self.build_only = build_only</span><br><span class="line">        self.alias = alias</span><br><span class="line">        <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.methods = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(methods, str):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">'param `methods` should be `Iterable[str]`, not `str`'</span>)</span><br><span class="line">            self.methods = set([x.upper() <span class="keyword">for</span> x <span class="keyword">in</span> methods])</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'HEAD'</span> <span class="keyword">not</span> <span class="keyword">in</span> self.methods <span class="keyword">and</span> <span class="string">'GET'</span> <span class="keyword">in</span> self.methods:</span><br><span class="line">                self.methods.add(<span class="string">'HEAD'</span>)</span><br><span class="line">        self.endpoint = endpoint</span><br><span class="line">        self.redirect_to = redirect_to</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> defaults:</span><br><span class="line">            self.arguments = set(map(str, defaults))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.arguments = set()</span><br><span class="line">        self._trace = self._converters = self._regex = self._argument_weights = <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>依旧是定义了很多属性，着重留意这几个: <code>self.rule</code>, <code>self.endpoint</code>, <code>self._regex</code>.</p>
<p>而werkzeug/routing.Map的add函数代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Map</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, rules=None, default_subdomain=<span class="string">''</span>, charset=<span class="string">'utf-8'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 strict_slashes=True, redirect_defaults=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                 converters=None, sort_parameters=False, sort_key=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 encoding_errors=<span class="string">'replace'</span>, host_matching=False)</span>:</span></span><br><span class="line">        self._rules = []</span><br><span class="line">        self._rules_by_endpoint = &#123;&#125;</span><br><span class="line">        self._remap = <span class="keyword">True</span></span><br><span class="line">        self._remap_lock = Lock()</span><br><span class="line"></span><br><span class="line">        self.default_subdomain = default_subdomain</span><br><span class="line">        self.charset = charset</span><br><span class="line">        self.encoding_errors = encoding_errors</span><br><span class="line">        self.strict_slashes = strict_slashes</span><br><span class="line">        self.redirect_defaults = redirect_defaults</span><br><span class="line">        self.host_matching = host_matching</span><br><span class="line"></span><br><span class="line">        self.converters = self.default_converters.copy()</span><br><span class="line">        <span class="keyword">if</span> converters:</span><br><span class="line">            self.converters.update(converters)</span><br><span class="line"></span><br><span class="line">        self.sort_parameters = sort_parameters</span><br><span class="line">        self.sort_key = sort_key</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> rulefactory <span class="keyword">in</span> rules <span class="keyword">or</span> ():</span><br><span class="line">            self.add(rulefactory)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, rulefactory)</span>:</span></span><br><span class="line">        <span class="string">"""Add a new rule or factory to the map and bind it.  Requires that the</span></span><br><span class="line"><span class="string">        rule is not bound to another map.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param rulefactory: a :class:`Rule` or :class:`RuleFactory`</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> rule <span class="keyword">in</span> rulefactory.get_rules(self):</span><br><span class="line">            rule.bind(self)</span><br><span class="line">            self._rules.append(rule)</span><br><span class="line">            self._rules_by_endpoint.setdefault(rule.endpoint, []).append(rule)</span><br><span class="line">        self._remap = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>add的关键，是rule.bind，而后再添加rule到<code>self._rules</code>和<code>self._rules_by_endpoint</code>这两个属性.</p>
<p>回到werkzeug/routing.Rule的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rule</span><span class="params">(RuleFactory)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bind</span><span class="params">(self, map, rebind=False)</span>:</span></span><br><span class="line">        <span class="string">"""Bind the url to a map and create a regular expression based on</span></span><br><span class="line"><span class="string">        the information from the rule itself and the defaults from the map.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :internal:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.map <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> <span class="keyword">not</span> rebind:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'url rule %r already bound to map %r'</span> %</span><br><span class="line">                               (self, self.map))</span><br><span class="line">        self.map = map</span><br><span class="line">        <span class="keyword">if</span> self.strict_slashes <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.strict_slashes = map.strict_slashes</span><br><span class="line">        <span class="keyword">if</span> self.subdomain <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.subdomain = map.default_subdomain</span><br><span class="line">        self.compile()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Compiles the regular expression and stores it."""</span></span><br><span class="line">        <span class="keyword">assert</span> self.map <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>, <span class="string">'rule not bound'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.map.host_matching:</span><br><span class="line">            domain_rule = self.host <span class="keyword">or</span> <span class="string">''</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            domain_rule = self.subdomain <span class="keyword">or</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        self._trace = []</span><br><span class="line">        self._converters = &#123;&#125;</span><br><span class="line">        self._static_weights = []</span><br><span class="line">        self._argument_weights = []</span><br><span class="line">        regex_parts = []</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_build_regex</span><span class="params">(rule)</span>:</span></span><br><span class="line">            index = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> converter, arguments, variable <span class="keyword">in</span> parse_rule(rule):</span><br><span class="line">                <span class="keyword">if</span> converter <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                    regex_parts.append(re.escape(variable))</span><br><span class="line">                    self._trace.append((<span class="keyword">False</span>, variable))</span><br><span class="line">                    <span class="keyword">for</span> part <span class="keyword">in</span> variable.split(<span class="string">'/'</span>):</span><br><span class="line">                        <span class="keyword">if</span> part:</span><br><span class="line">                            self._static_weights.append((index, -len(part)))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> arguments:</span><br><span class="line">                        c_args, c_kwargs = parse_converter_args(arguments)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        c_args = ()</span><br><span class="line">                        c_kwargs = &#123;&#125;</span><br><span class="line">                    convobj = self.get_converter(</span><br><span class="line">                        variable, converter, c_args, c_kwargs)</span><br><span class="line">                    regex_parts.append(<span class="string">'(?P&lt;%s&gt;%s)'</span> % (variable, convobj.regex))</span><br><span class="line">                    self._converters[variable] = convobj</span><br><span class="line">                    self._trace.append((<span class="keyword">True</span>, variable))</span><br><span class="line">                    self._argument_weights.append(convobj.weight)</span><br><span class="line">                    self.arguments.add(str(variable))</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        _build_regex(domain_rule)</span><br><span class="line">        regex_parts.append(<span class="string">'\\|'</span>)</span><br><span class="line">        self._trace.append((<span class="keyword">False</span>, <span class="string">'|'</span>))</span><br><span class="line">        _build_regex(self.is_leaf <span class="keyword">and</span> self.rule <span class="keyword">or</span> self.rule.rstrip(<span class="string">'/'</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_leaf:</span><br><span class="line">            self._trace.append((<span class="keyword">False</span>, <span class="string">'/'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.build_only:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        regex = <span class="string">r'^%s%s$'</span> % (</span><br><span class="line">            <span class="string">u''</span>.join(regex_parts),</span><br><span class="line">            (<span class="keyword">not</span> self.is_leaf <span class="keyword">or</span> <span class="keyword">not</span> self.strict_slashes) <span class="keyword">and</span></span><br><span class="line">            <span class="string">'(?&lt;!/)(?P&lt;__suffix__&gt;/?)'</span> <span class="keyword">or</span> <span class="string">''</span></span><br><span class="line">        )</span><br><span class="line">        self._regex = re.compile(regex, re.UNICODE)</span><br></pre></td></tr></table></figure>
<p>可见，URL的模式是以正则表达式来匹配的。’/hello/\<name>‘ 这个rule对应的正则是：</name></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.compile(<span class="string">'^\\|\\/hello\\/(?P&lt;name&gt;[^/]&#123;1,&#125;)$'</span>)</span><br></pre></td></tr></table></figure>
<p>这时候的flask/app.Flask <code>self.url_map</code>属性如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;'_rules': [&lt;Rule '/static/&lt;filename&gt;' (HEAD, GET, OPTIONS) -&gt; static&gt;, &lt;Rule '/hello/&lt;name&gt;' (HEAD, GET, OPTIONS) -&gt; index&gt;], '_rules_by_endpoint': &#123;'static': [&lt;Rule '/static/&lt;filename&gt;' (HEAD, GET, OPTIONS) -&gt; static&gt;], 'index': [&lt;Rule '/hello/&lt;name&gt;' (HEAD, GET, OPTIONS) -&gt; index&gt;]&#125;, '_remap': True, '_remap_lock': &lt;unlocked _thread.lock object at 0x7f9c60af1af8&gt;, 'default_subdomain': '', 'charset': 'utf-8', 'encoding_errors': 'replace', 'strict_slashes': True, 'redirect_defaults': True, 'host_matching': False, 'converters': &#123;'default': &lt;class 'werkzeug.routing.UnicodeConverter'&gt;, 'string': &lt;class 'werkzeug.routing.UnicodeConverter'&gt;, 'any': &lt;class 'werkzeug.routing.AnyConverter'&gt;, 'path': &lt;class 'werkzeug.routing.PathConverter'&gt;, 'int': &lt;class 'werkzeug.routing.IntegerConverter'&gt;, 'float': &lt;class 'werkzeug.routing.FloatConverter'&gt;, 'uuid': &lt;class 'werkzeug.routing.UUIDConverter'&gt;&#125;, 'sort_parameters': False, 'sort_key': None&#125;</span><br></pre></td></tr></table></figure>
<p>至此，urlpattern -&gt; endpoint -&gt; view_func的链条就建立好了，收到请求后就是按照这个链条去找到对应的视图函数进行处理进而给出响应的。</p>
<p><strong>现在可以开始分析请求的处理过程了</strong></p>
<p>根据WSGI规范，应用必须是一个可调用对象，接受服务器传入的environ和start_response两个参数，我们看一下flask.app.Flask的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">    <span class="string">"""The WSGI server calls the Flask application object as the</span></span><br><span class="line"><span class="string">    WSGI application. This calls :meth:`wsgi_app` which can be</span></span><br><span class="line"><span class="string">    wrapped to applying middleware."""</span></span><br><span class="line">    response = self.wsgi_app(environ, start_response)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>Flask类实现了__call__这个方法, 并且把实际的处理转移到了wsgi_app方法中，继续刨:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ctx.push()</span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="keyword">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>
<p>主要是这几步:</p>
<ul>
<li>ctx = self.request_context(environ) – 解析请求上下文</li>
<li>ctx.push() – 将请求上下文推入栈中</li>
<li>response = self.full_dispatch_request() – 分派处理并得到响应</li>
<li>return response(environ, start_response) – 响应发送给服务器</li>
</ul>
<p>其他的异常处理就不说了。</p>
<p>逐一来分析以上4个步骤:</p>
<h5 id="解析请求上下文"><a href="#解析请求上下文" class="headerlink" title="解析请求上下文"></a>解析请求上下文</h5><p>先启动服务器:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn -w 1 -b 0.0.0.0:8000 analyze_flask:app</span><br></pre></td></tr></table></figure>
<p>请求<a href="http://0.0.0.0:8000/hello/flask" target="_blank" rel="noopener">http://0.0.0.0:8000/hello/flask</a> ，打印出environ变量:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;'wsgi.errors': &lt;gunicorn.http.wsgi.WSGIErrorsWrapper object at 0x7f11a2eea908&gt;, 'wsgi.version': (1, 0), 'wsgi.multithread': False, 'wsgi.multiprocess': False, 'wsgi.run_once': False, 'wsgi.file_wrapper': &lt;class 'gunicorn.http.wsgi.FileWrapper'&gt;, 'SERVER_SOFTWARE': 'gunicorn/19.9.0', 'wsgi.input': &lt;gunicorn.http.body.Body object at 0x7f11a2eea710&gt;, 'gunicorn.socket': &lt;socket.socket fd=9, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('127.0.0.1', 8000), raddr=('127.0.0.1', 60080)&gt;, 'REQUEST_METHOD': 'GET', 'QUERY_STRING': '', 'RAW_URI': '/hello/flask', 'SERVER_PROTOCOL': 'HTTP/1.1', 'HTTP_HOST': '0.0.0.0:8000', 'HTTP_CONNECTION': 'keep-alive', 'HTTP_CACHE_CONTROL': 'max-age=0', 'HTTP_UPGRADE_INSECURE_REQUESTS': '1', 'HTTP_USER_AGENT': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/70.0.3538.77 Chrome/70.0.3538.77 Safari/537.36', 'HTTP_ACCEPT': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate', 'HTTP_ACCEPT_LANGUAGE': 'en-US,en;q=0.9,zh-CN;q=0.8,zh-TW;q=0.7,zh;q=0.6', 'wsgi.url_scheme': 'http', 'REMOTE_ADDR': '127.0.0.1', 'REMOTE_PORT': '60080', 'SERVER_NAME': '0.0.0.0', 'SERVER_PORT': '8000', 'PATH_INFO': '/hello/flask', 'SCRIPT_NAME': ''&#125;</span><br></pre></td></tr></table></figure>
<p>这个是很重要的哈，因为解析请求上下文要用到的参数就是environ:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask/app.py</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request_context</span><span class="params">(self, environ)</span>:</span></span><br><span class="line">        <span class="string">"""Create a :class:`~flask.ctx.RequestContext` representing a</span></span><br><span class="line"><span class="string">        WSGI environment. Use a ``with`` block to push the context,</span></span><br><span class="line"><span class="string">        which will make :data:`request` point at this request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        See :doc:`/reqcontext`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Typically you should not call this from your own code. A request</span></span><br><span class="line"><span class="string">        context is automatically pushed by the :meth:`wsgi_app` when</span></span><br><span class="line"><span class="string">        handling a request. Use :meth:`test_request_context` to create</span></span><br><span class="line"><span class="string">        an environment and context instead of this method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param environ: a WSGI environment</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> RequestContext(self, environ)</span><br></pre></td></tr></table></figure>
<p>所以,  ctx = self.request_context(environ)中的ctx变量其实就是flask/ctx.RequestContext这个类的实例, 类的构造函数如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask/ctx.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></span><br><span class="line">        self.app = app</span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            request = app.request_class(environ)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.url_adapter = app.create_url_adapter(self.request)</span><br><span class="line">        self.match_request()</span><br><span class="line">		......</span><br></pre></td></tr></table></figure>
<p>a)先是用environ去构造flask/wrappers.Request的实例: request</p>
<p>b)接着要求出url调制器: url_adapter</p>
<p>c)最后是匹配请求，看命中的是哪一个urlpattern</p>
<p>a没什么好讲的，看下b这步:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask/app.py</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">create_url_adapter</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Creates a URL adapter for the given request. The URL adapter</span></span><br><span class="line"><span class="string">        is created at a point where the request context is not yet set</span></span><br><span class="line"><span class="string">        up so the request is passed explicitly.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionadded:: 0.6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionchanged:: 0.9</span></span><br><span class="line"><span class="string">           This can now also be called without a request object when the</span></span><br><span class="line"><span class="string">           URL adapter is created for the application context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionchanged:: 1.0</span></span><br><span class="line"><span class="string">            :data:`SERVER_NAME` no longer implicitly enables subdomain</span></span><br><span class="line"><span class="string">            matching. Use :attr:`subdomain_matching` instead.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="comment"># If subdomain matching is disabled (the default), use the</span></span><br><span class="line">            <span class="comment"># default subdomain in all cases. This should be the default</span></span><br><span class="line">            <span class="comment"># in Werkzeug but it currently does not have that feature.</span></span><br><span class="line">            subdomain = ((self.url_map.default_subdomain <span class="keyword">or</span> <span class="keyword">None</span>)</span><br><span class="line">                         <span class="keyword">if</span> <span class="keyword">not</span> self.subdomain_matching <span class="keyword">else</span> <span class="keyword">None</span>)</span><br><span class="line">            <span class="keyword">return</span> self.url_map.bind_to_environ(</span><br><span class="line">                request.environ,</span><br><span class="line">                server_name=self.config[<span class="string">'SERVER_NAME'</span>],</span><br><span class="line">                subdomain=subdomain)</span><br><span class="line">        <span class="comment"># We need at the very least the server name to be set for this</span></span><br><span class="line">        <span class="comment"># to work.</span></span><br><span class="line">        <span class="keyword">if</span> self.config[<span class="string">'SERVER_NAME'</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self.url_map.bind(</span><br><span class="line">                self.config[<span class="string">'SERVER_NAME'</span>],</span><br><span class="line">                script_name=self.config[<span class="string">'APPLICATION_ROOT'</span>],</span><br><span class="line">                url_scheme=self.config[<span class="string">'PREFERRED_URL_SCHEME'</span>])</span><br></pre></td></tr></table></figure>
<p>因为我们的request不是None， 所以走的是这一步:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> self.url_map.bind_to_environ(</span><br><span class="line">                request.environ,</span><br><span class="line">                server_name=self.config[<span class="string">'SERVER_NAME'</span>],</span><br><span class="line">                subdomain=subdomain)</span><br></pre></td></tr></table></figure>
<p>又要看werkzeug/routing.Map的代码了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Map</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bind_to_environ</span><span class="params">(self, environ, server_name=None, subdomain=None)</span>:</span></span><br><span class="line">		......</span><br><span class="line">        <span class="keyword">return</span> Map.bind(self, server_name, script_name,</span><br><span class="line">                        subdomain, environ[<span class="string">'wsgi.url_scheme'</span>],</span><br><span class="line">                        environ[<span class="string">'REQUEST_METHOD'</span>], path_info,</span><br><span class="line">                        query_args=query_args)</span><br><span class="line">                       </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bind</span><span class="params">(self, server_name, script_name=None, subdomain=None,</span></span></span><br><span class="line"><span class="function"><span class="params">             url_scheme=<span class="string">'http'</span>, default_method=<span class="string">'GET'</span>, path_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">             query_args=None)</span>:</span></span><br><span class="line">		......</span><br><span class="line">        <span class="keyword">return</span> MapAdapter(self, server_name, script_name, subdomain,</span><br><span class="line">                          url_scheme, path_info, default_method, query_args)</span><br></pre></td></tr></table></figure>
<p>看来最终b这一步得到的是MapAdapter这个类的实例，其构造函数如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapAdapter</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""Returned by :meth:`Map.bind` or :meth:`Map.bind_to_environ` and does</span></span><br><span class="line"><span class="string">    the URL matching and building based on runtime information.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, map, server_name, script_name, subdomain,</span></span></span><br><span class="line"><span class="function"><span class="params">                 url_scheme, path_info, default_method, query_args=None)</span>:</span></span><br><span class="line">        self.map = map</span><br><span class="line">        self.server_name = to_unicode(server_name)</span><br><span class="line">        script_name = to_unicode(script_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> script_name.endswith(<span class="string">u'/'</span>):</span><br><span class="line">            script_name += <span class="string">u'/'</span></span><br><span class="line">        self.script_name = script_name</span><br><span class="line">        self.subdomain = to_unicode(subdomain)</span><br><span class="line">        self.url_scheme = to_unicode(url_scheme)</span><br><span class="line">        self.path_info = to_unicode(path_info)</span><br><span class="line">        self.default_method = to_unicode(default_method)</span><br><span class="line">        self.query_args = query_args</span><br></pre></td></tr></table></figure>
<p>轮到c这一步了，match_request:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line">	......</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">match_request</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Can be overridden by a subclass to hook into the matching</span></span><br><span class="line"><span class="string">        of the request.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url_rule, self.request.view_args = \</span><br><span class="line">                self.url_adapter.match(return_rule=<span class="keyword">True</span>)</span><br><span class="line">            self.request.url_rule = url_rule</span><br><span class="line">        <span class="keyword">except</span> HTTPException <span class="keyword">as</span> e:</span><br><span class="line">            self.request.routing_exception = e</span><br></pre></td></tr></table></figure>
<p>要调用self.url_adapter的match方法进行匹配，并指定返回rule(关键字参数return_rule=True):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapAdapter</span><span class="params">(object)</span>:</span></span><br><span class="line">	......</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, path_info=None, method=None, return_rule=False,</span></span></span><br><span class="line"><span class="function"><span class="params">              query_args=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> path_info <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            path_info = self.path_info</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            path_info = to_unicode(path_info, self.map.charset)</span><br><span class="line">        <span class="keyword">if</span> query_args <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            query_args = self.query_args</span><br><span class="line">        method = (method <span class="keyword">or</span> self.default_method).upper()</span><br><span class="line"></span><br><span class="line">        path = <span class="string">u'%s|%s'</span> % (</span><br><span class="line">            self.map.host_matching <span class="keyword">and</span> self.server_name <span class="keyword">or</span> self.subdomain,</span><br><span class="line">            path_info <span class="keyword">and</span> <span class="string">'/%s'</span> % path_info.lstrip(<span class="string">'/'</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">for</span> rule <span class="keyword">in</span> self.map._rules:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                rv = rule.match(path, method)</span><br><span class="line">            <span class="keyword">except</span> RequestSlash:</span><br><span class="line">                <span class="keyword">raise</span> RequestRedirect(self.make_redirect_url(</span><br><span class="line">                    url_quote(path_info, self.map.charset,</span><br><span class="line">                              safe=<span class="string">'/:|+'</span>) + <span class="string">'/'</span>, query_args))</span><br><span class="line">            <span class="keyword">except</span> RequestAliasRedirect <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">raise</span> RequestRedirect(self.make_alias_redirect_url(</span><br><span class="line">                    path, rule.endpoint, e.matched_values, method, query_args))</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> return_rule:</span><br><span class="line">                <span class="keyword">return</span> rule, rv</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> rule.endpoint, rv</span><br></pre></td></tr></table></figure>
<p>核心是构建path，遍历Map中每一个rule, 调用rule.match方法进行匹配。</p>
<p>又要回到werkzeug/routing.Rule了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rule</span><span class="params">(RuleFactory)</span>:</span></span><br><span class="line">	......</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(self, path, method=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.build_only:</span><br><span class="line">            m = self._regex.search(path)</span><br><span class="line">            <span class="keyword">if</span> m <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                groups = m.groupdict()</span><br><span class="line">                result = &#123;&#125;</span><br><span class="line">                <span class="keyword">for</span> name, value <span class="keyword">in</span> iteritems(groups):</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        value = self._converters[name].to_python(value)</span><br><span class="line">                    <span class="keyword">except</span> ValidationError:</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    result[str(name)] = value</span><br><span class="line">                <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>在Rule.match中，用rule._regex去匹配path, 如果匹配到，则返回请求参数这个字典，否则返回None.<br>回忆一下我们构建的map._rules有哪些:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;'_rules': [&lt;Rule '/static/&lt;filename&gt;' (HEAD, GET, OPTIONS) -&gt; static&gt;, &lt;Rule '/hello/&lt;name&gt;' (HEAD, GET, OPTIONS) -&gt; index&gt;, &lt;Rule '/hi' (HEAD, GET, OPTIONS) -&gt; hi&gt;]&#125;</span><br></pre></td></tr></table></figure></p>
<p>在MapAdapter中，如果匹配到就直接<code>return rule, rv</code>, 否则就尝试匹配下一个rule.<br>ok, 步骤c终于完了。<br>现在，我们知道请求命中的是哪一个rule, 请求的参数是什么了。看一下ctx的属性吧:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ctx.request.__dict__</span></span><br><span class="line"></span><br><span class="line">&#123;'environ': &#123;'wsgi.errors': &lt;gunicorn.http.wsgi.WSGIErrorsWrapper object at 0x7f52c6bc0ac8&gt;, 'wsgi.version': (1, 0), 'wsgi.multithread': False, 'wsgi.multiprocess': False, 'wsgi.run_once': False, 'wsgi.file_wrapper': &lt;class 'gunicorn.http.wsgi.FileWrapper'&gt;, 'SERVER_SOFTWARE': 'gunicorn/19.9.0', 'wsgi.input': &lt;gunicorn.http.body.Body object at 0x7f52c6bc08d0&gt;, 'gunicorn.socket': &lt;socket.socket fd=9, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('127.0.0.1', 8000), raddr=('127.0.0.1', 60598)&gt;, 'REQUEST_METHOD': 'GET', 'QUERY_STRING': '', 'RAW_URI': '///hello/flask', 'SERVER_PROTOCOL': 'HTTP/1.1', 'HTTP_HOST': '0.0.0.0:8000', 'HTTP_CONNECTION': 'keep-alive', 'HTTP_CACHE_CONTROL': 'max-age=0', 'HTTP_UPGRADE_INSECURE_REQUESTS': '1', 'HTTP_USER_AGENT': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/70.0.3538.77 Chrome/70.0.3538.77 Safari/537.36', 'HTTP_ACCEPT': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate', 'HTTP_ACCEPT_LANGUAGE': 'en-US,en;q=0.9,zh-CN;q=0.8,zh-TW;q=0.7,zh;q=0.6', 'wsgi.url_scheme': 'http', 'REMOTE_ADDR': '127.0.0.1', 'REMOTE_PORT': '60598', 'SERVER_NAME': '0.0.0.0', 'SERVER_PORT': '8000', 'PATH_INFO': '///hello/flask', 'SCRIPT_NAME': '', 'werkzeug.request': &lt;Request 'http://0.0.0.0:8000/hello/flask' [GET]&gt;&#125;, 'shallow': False, 'view_args': &#123;'name': 'flask'&#125;, 'url_rule': &lt;Rule '/hello/&lt;name&gt;' (GET, OPTIONS, HEAD) -&gt; index&gt;, 'url': 'http://0.0.0.0:8000/hello/flask'&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;'view_args': &#123;'name': 'flask'&#125;, 'url_rule': &lt;Rule '/hello/&lt;name&gt;' (GET, OPTIONS, HEAD) -&gt; index&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>这就是请求要访问的rule和请求的参数。</p>
<h5 id="将请求上下文推入栈中"><a href="#将请求上下文推入栈中" class="headerlink" title="将请求上下文推入栈中"></a>将请求上下文推入栈中</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></span><br><span class="line">        top = _request_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> top.preserved:</span><br><span class="line">            top.pop(top._preserved_exc)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Before we push the request context we have to ensure that there</span></span><br><span class="line">        <span class="comment"># is an application context.</span></span><br><span class="line">        app_ctx = _app_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</span><br><span class="line">            app_ctx = self.app.app_context()</span><br><span class="line">            app_ctx.push()</span><br><span class="line">            self._implicit_app_ctx_stack.append(app_ctx)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._implicit_app_ctx_stack.append(<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(sys, <span class="string">'exc_clear'</span>):</span><br><span class="line">            sys.exc_clear()</span><br><span class="line"></span><br><span class="line">        _request_ctx_stack.push(self)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            session_interface = self.app.session_interface</span><br><span class="line">            self.session = session_interface.open_session(</span><br><span class="line">                self.app, self.request</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                self.session = session_interface.make_null_session(self.app)</span><br></pre></td></tr></table></figure>
<p>ctx被推入<code>_request_ctx_stack</code>中。</p>
<h5 id="分派处理并得到响应"><a href="#分派处理并得到响应" class="headerlink" title="分派处理并得到响应"></a>分派处理并得到响应</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Dispatches the request and on top of that performs request</span></span><br><span class="line"><span class="string">        pre and postprocessing as well as HTTP exception catching and</span></span><br><span class="line"><span class="string">        error handling.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionadded:: 0.7</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.try_trigger_before_first_request_functions()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request_started.send(self)</span><br><span class="line">            rv = self.preprocess_request()</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                rv = self.dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            rv = self.handle_user_exception(e)</span><br><span class="line">        <span class="keyword">return</span> self.finalize_request(rv)</span><br></pre></td></tr></table></figure>
<p>先是调用preprocess_request函数，执行所有要求在请求处理前要完成的函数，如果这一步有返回值的话，那么就不会调用dispatch_request来真正的处理请求了，否则就接着调用dispatch_request函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="comment"># if we provide automatic options for this URL and the</span></span><br><span class="line">    <span class="comment"># request came with the OPTIONS method, reply automatically</span></span><br><span class="line">    <span class="keyword">if</span> getattr(rule, <span class="string">'provide_automatic_options'</span>, <span class="keyword">False</span>) \</span><br><span class="line">       <span class="keyword">and</span> req.method == <span class="string">'OPTIONS'</span>:</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="comment"># otherwise dispatch to the handler for that endpoint</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br></pre></td></tr></table></figure>
<p>从_request_ctx_stack找出我们刚刚压入的ctx对象的request属性，并据此找出请求的rule和rule.endpoint, 接下来就简单了，根据rule.endpoint从view_functions中找到对应的路由函数，并以view_args作为参数来调用，返回结果再由finalize_request处理:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span><span class="params">(self, rv, from_error_handler=False)</span>:</span></span><br><span class="line">    response = self.make_response(rv)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        request_finished.send(self, response=response)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        self.logger.exception(<span class="string">'Request finalizing failed with an '</span></span><br><span class="line">                              <span class="string">'error while handling an error'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>finalize_request的作用就是将视图函数的返回值转换成Response的实例对象, 并调用后处理函数对response进行处理。</p>
<h5 id="响应发送给服务器"><a href="#响应发送给服务器" class="headerlink" title="响应发送给服务器"></a>响应发送给服务器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># werkzeug/wrappers.BaseResponse</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_wsgi_response</span><span class="params">(self, environ)</span>:</span></span><br><span class="line">        <span class="string">"""Returns the final WSGI response as tuple.  The first item in</span></span><br><span class="line"><span class="string">        the tuple is the application iterator, the second the status and</span></span><br><span class="line"><span class="string">        the third the list of headers.  The response returned is created</span></span><br><span class="line"><span class="string">        specially for the given environment.  For example if the request</span></span><br><span class="line"><span class="string">        method in the WSGI environment is ``'HEAD'`` the response will</span></span><br><span class="line"><span class="string">        be empty and only the headers and status code will be present.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionadded:: 0.6</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param environ: the WSGI environment of the request.</span></span><br><span class="line"><span class="string">        :return: an ``(app_iter, status, headers)`` tuple.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        headers = self.get_wsgi_headers(environ)</span><br><span class="line">        app_iter = self.get_app_iter(environ)</span><br><span class="line">        <span class="keyword">return</span> app_iter, self.status, headers.to_wsgi_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        <span class="string">"""Process this response as WSGI application.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param environ: the WSGI environment.</span></span><br><span class="line"><span class="string">        :param start_response: the response callable provided by the WSGI</span></span><br><span class="line"><span class="string">                               server.</span></span><br><span class="line"><span class="string">        :return: an application iterator</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        app_iter, status, headers = self.get_wsgi_response(environ)</span><br><span class="line">        start_response(status, headers)</span><br><span class="line">        <span class="keyword">return</span> app_iter</span><br></pre></td></tr></table></figure>
<p>典型的WSGI调用方式.</p>
<p>至此，一个请求就处理完了。</p>
<p>撒花~</p>
</div><div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/Flask/">Flask</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/12/05/Dive-into-flask-principle-of-Context/" class="pre">Dive into flask: principle of Context</a><a href="/2018/11/22/beginner-to-Django-6/" class="next">beginner to Django 6</a></div><div id="comments"><div id="disqus_thread"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#解析请求上下文"><span class="toc-text">解析请求上下文</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#将请求上下文推入栈中"><span class="toc-text">将请求上下文推入栈中</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#分派处理并得到响应"><span class="toc-text">分派处理并得到响应</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#响应发送给服务器"><span class="toc-text">响应发送给服务器</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/996-lay-off-middle-crisis/">996&lay off&middle crisis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/27/MongoDB-usage-of-common-apis/">MongoDB: usage of common apis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/21/Redis-usage-of-common-apis/">Redis: usage of common apis</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/25/Dive-into-Algorithm-quicksort/">Dive into Algorithm:quicksort</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/18/Dive-into-Python-singleton/">Dive into Python: singleton</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/05/Dive-into-flask-principle-of-Context/">Dive into flask: principle of Context</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/30/Dive-into-flask-the-journey-of-one-request/">Dive into flask: journey of one request</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/22/beginner-to-Django-6/">beginner to Django 6</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/beginner-to-Django-5/">beginner to Django 5</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/19/beginner-to-Django-4/">beginner to Django 4</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Johoo.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>var disqus_shortname = 'johoo';
var disqus_identifier = '2018/11/30/Dive-into-flask-the-journey-of-one-request/';
var disqus_title = 'Dive into flask: journey of one request';
var disqus_url = 'https://johoo26.github.io/2018/11/30/Dive-into-flask-the-journey-of-one-request/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//johoo.disqus.com/count.js" async></script><script type="text/javascript" src="//johoo.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></body></html>
{"name":"Django","slug":"Django","count":3,"postlist":[{"title":"beginner to Django","slug":"beginner-to-Django-1","date":"2018-11-08T15:56:23.000Z","updated":"2018-11-16T06:57:26.600Z","comments":true,"path":"api/articles/beginner-to-Django-1.json","excerpt":"","keywords":null,"cover":null,"content":"<p>最近在学习Django的使用，把相关的知识点记录下来，毕竟只有经历了比输出更残酷的输入，才算是真正掌握对应的知识点。<br>Django和Flask是Python Web开发框架中使用最多的两个框架，两者最大的不同之处在于，Flask只提供一个强健的内核，而Django则尽可能把所有的工具都集成在自身中，即Battery-included.这样做的好处在于，你无须去互联网上找别人开发的扩展，毕竟扩展开发人员的水平无法保证，出了问题也不一定能得到解决，在Django这里，有一个出色的团队在开发和维护，一切都可控。Django的另一个优点是，规定了包的组织架构，特别适合一个团队一起开发项目时使用，而Flask则很考验开发人员自身的代码架构水平了，遇到水平参差不齐的同事的话，可能会比较痛苦。</p>\n<p>OK，开始跟着Django官网的tutorial学习Django！</p>\n<p>首先创建一个项目project:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">❯ django-admin startproject myproj</span><br></pre></td></tr></table></figure>\n<p>会看到当前目录下多了一个myproj的目录，结构如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) /tmp ❯ tree myproj </span><br><span class=\"line\">myproj</span><br><span class=\"line\">├── manage.py</span><br><span class=\"line\">└── myproj</span><br><span class=\"line\">    ├── __init__.py</span><br><span class=\"line\">    ├── settings.py</span><br><span class=\"line\">    ├── urls.py</span><br><span class=\"line\">    └── wsgi.py</span><br><span class=\"line\"></span><br><span class=\"line\">1 directory, 5 files</span><br></pre></td></tr></table></figure>\n<p><code>manage.py</code>是一个管理入口，所能做的事情其实和命令 <code>django-admin</code> 是一样的，但<code>manage.py</code>额外为我们做了这几件事：</p>\n<ul>\n<li>将项目的包路经加到<code>sys.path</code>中</li>\n<li>设置环境变量<code>DJANGO_SETTINGS_MODULE</code>，使其指向项目的<code>settings.py</code></li>\n</ul>\n<p>一般来说，单个项目开发的时候使用<code>manage.py</code>会更容易，而如果要在多个项目中跳转，则应使用<code>django-admin</code>.</p>\n<p>里层的myproj目录则是实际的项目包。</p>\n<p><code>myproj/settings.py</code>中放置的是myproj项目的设置，<code>myproj/urls.py</code>是项目的url分配器，<code>myproj/wsgi.py</code>是WSGI服务器运行web_app的入口。</p>\n<p>先启动试一下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py runserver</span><br></pre></td></tr></table></figure>\n<p>就可以在<a href=\"http://127.0.0.1:8000/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8000/</a>  看到默认页面了。</p>\n<p>需要指出的是，这里启动用的是Django内置的方便开发而设置的服务器，不能用于生产环境。</p>\n<p>现在创建一个投票应用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py startapp polls</span><br></pre></td></tr></table></figure>\n<p>app 是一个项目中具体做事情的部分，项目中可以含有多个app， app也可以置于多个项目中。</p>\n<p>app可以位于任何pythonpath内的路经，这里放在<code>manage.py</code>同一级只是为了导入方便。</p>\n<p>看一下polls的内容：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ tree polls </span><br><span class=\"line\">polls</span><br><span class=\"line\">├── admin.py</span><br><span class=\"line\">├── apps.py</span><br><span class=\"line\">├── __init__.py</span><br><span class=\"line\">├── migrations</span><br><span class=\"line\">│   └── __init__.py</span><br><span class=\"line\">├── models.py</span><br><span class=\"line\">├── tests.py</span><br><span class=\"line\">└── views.py</span><br></pre></td></tr></table></figure>\n<p><code>startapp</code> 命令自动帮我们生成以上文件，节省了开发人员设计的时间。是不是很方便？</p>\n<p>现在创建一个真正的视图。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># polls/views.py</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your views here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">(request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">'Hello Django!'</span>)</span><br></pre></td></tr></table></figure>\n<p>要想访问到index视图函数，需要有url映射到这里来，在<code>polls/views.py</code>同级目录下创建<code>urls.py</code>模块，并写入如下内容：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># polls/urls.py</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> . <span class=\"keyword\">import</span> views</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">''</span>, views.index, name=<span class=\"string\">'index'</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>path函数的第一个参数是route, 第二个参数是view func, 关键字参数name是为了便于动态构建url用的。</p>\n<p>这样就可以了吗？当然不行，还在把<code>polls/urls.py</code>注册到<code>myproj/urls.py</code>中才行，因为myproj才是入口：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># myproj/urls.py</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"myproj URL Configuration</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">The `urlpatterns` list routes URLs to views. For more information please see:</span></span><br><span class=\"line\"><span class=\"string\">    https://docs.djangoproject.com/en/2.1/topics/http/urls/</span></span><br><span class=\"line\"><span class=\"string\">Examples:</span></span><br><span class=\"line\"><span class=\"string\">Function views</span></span><br><span class=\"line\"><span class=\"string\">    1. Add an import:  from my_app import views</span></span><br><span class=\"line\"><span class=\"string\">    2. Add a URL to urlpatterns:  path('', views.home, name='home')</span></span><br><span class=\"line\"><span class=\"string\">Class-based views</span></span><br><span class=\"line\"><span class=\"string\">    1. Add an import:  from other_app.views import Home</span></span><br><span class=\"line\"><span class=\"string\">    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')</span></span><br><span class=\"line\"><span class=\"string\">Including another URLconf</span></span><br><span class=\"line\"><span class=\"string\">    1. Import the include() function: from django.urls import include, path</span></span><br><span class=\"line\"><span class=\"string\">    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib <span class=\"keyword\">import</span> admin</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path, include</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">'polls/'</span>, include(<span class=\"string\">'polls.urls'</span>)),</span><br><span class=\"line\">    path(<span class=\"string\">'admin/'</span>, admin.site.urls),</span><br><span class=\"line\">    </span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\"># 上面介绍了3种添加路由的方法，Django推荐用 include， 只有一个例外: admin.</span></span><br><span class=\"line\"><span class=\"comment\"># include函数会把匹配到的url截掉开头匹配的模式后传递给引入的url模块，这样的话</span></span><br><span class=\"line\"><span class=\"comment\"># 前面匹配的模块就不会写死，可以根据需求任意调整成比如 'polls2/', 'fun-polls/'，</span></span><br><span class=\"line\"><span class=\"comment\"># 视图函数完全不用任何改变。</span></span><br></pre></td></tr></table></figure>\n<p>启动server,然后就可以在 <a href=\"http://localhost:8000/polls/\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/polls/</a>  看到响应内容”Hello Django!”.</p>\n","text":"最近在学习Django的使用，把相关的知识点记录下来，毕竟只有经历了比输出更残酷的输入，才算是真正掌握对应的知识点。<br>Django和Flask是Python Web开发框架中使用最多的两个框架，两者最大的不同之处在于，Flask只提供一个强健的内核，而Django则尽可能把","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Python","slug":"Python","count":4,"path":"api/tags/Python.json"},{"name":"Django","slug":"Django","count":3,"path":"api/tags/Django.json"}]},{"title":"beginner to Django 2","slug":"beginner-to-Django-2","date":"2018-11-16T07:01:41.000Z","updated":"2018-11-16T08:49:49.139Z","comments":true,"path":"api/articles/beginner-to-Django-2.json","excerpt":"","keywords":null,"cover":null,"content":"<p>今天要涉及的部分是数据库和模型，以及Django自带的admin管理端。</p>\n<p>Django支持很多常见的数据库，我这里选择用MySQL。要能让Django与MySQL交互，Django官方推荐安装mysqlclient–直接pip安装即可。数据库配置在<code>myproj/settings.py</code>中：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Database</span></span><br><span class=\"line\"><span class=\"comment\"># https://docs.djangoproject.com/en/2.1/ref/settings/#databases</span></span><br><span class=\"line\"></span><br><span class=\"line\">DATABASES = &#123;</span><br><span class=\"line\">    <span class=\"string\">'default'</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">'ENGINE'</span>: <span class=\"string\">'django.db.backends.mysql'</span>,</span><br><span class=\"line\">        <span class=\"string\">'NAME'</span>: <span class=\"string\">'db_django'</span>,</span><br><span class=\"line\">        <span class=\"string\">'USER'</span>: <span class=\"string\">'test'</span>,</span><br><span class=\"line\">        <span class=\"string\">'PASSWORD'</span>: <span class=\"string\">'test'</span>,</span><br><span class=\"line\">        <span class=\"string\">'HOST'</span>: <span class=\"string\">'localhost'</span>,</span><br><span class=\"line\">        <span class=\"string\">'PORT'</span>: <span class=\"string\">'3306'</span>,</span><br><span class=\"line\">        <span class=\"string\">'OPTIONS'</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">'init_command'</span>: <span class=\"string\">\"SET sql_mode='STRICT_TRANS_TABLES'\"</span>,</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 需要事先在MySQL中创建一个叫db_django的库，创建用户test,密码test,并授予其对应权限</span></span><br><span class=\"line\"><span class=\"comment\"># 此外，Django强烈要求打开MySQL的strict-mode,我查了一下，这个确实很好用，会把很多</span></span><br><span class=\"line\"><span class=\"comment\"># 错误的请求从原来仅仅给出warning调为直接error报错，安全级别更高了</span></span><br></pre></td></tr></table></figure>\n<p>顺便把时区改成自己的：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># settings.py</span></span><br><span class=\"line\"></span><br><span class=\"line\">TIME_ZONE = <span class=\"string\">'Asia/Shanghai'</span></span><br></pre></td></tr></table></figure>\n<p>注意到<code>myproj/settings.py</code>中这样一个变量：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Application definition</span></span><br><span class=\"line\"></span><br><span class=\"line\">INSTALLED_APPS = [</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.admin'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.auth'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.contenttypes'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.sessions'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.messages'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.staticfiles'</span>,</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>这些是Django默认自带的应用，因为这些基本上所有场景都会用到。如果不需要的话可以注释掉。由于以上apps中有些需要库表，所以执行以下命令进行迁移：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py migrate</span><br></pre></td></tr></table></figure>\n<p>然后就可以在db_django库中看到已经有对应的tables了：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql test@localhost:db_django&gt; SHOW tables;</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">| Tables_in_db_django        |</span><br><span class=\"line\">|----------------------------|</span><br><span class=\"line\">| auth_group                 |</span><br><span class=\"line\">| auth_group_permissions     |</span><br><span class=\"line\">| auth_permission            |</span><br><span class=\"line\">| auth_user                  |</span><br><span class=\"line\">| auth_user_groups           |</span><br><span class=\"line\">| auth_user_user_permissions |</span><br><span class=\"line\">| django_admin_log           |</span><br><span class=\"line\">| django_content_type        |</span><br><span class=\"line\">| django_migrations          |</span><br><span class=\"line\">| django_session             |</span><br><span class=\"line\">+----------------------------+</span><br></pre></td></tr></table></figure>\n<p>migrate命令的作用是根据模型进行数据库同步，它只会同步<code>INSTALLED_APPS</code>中的应用涉及到的库表。</p>\n<p>现在开始创建模型。模型差不多可以认为是数据库的表，只不过能做的事情多得多。这里需要创建两个models: Question 和 Choice. 编辑 <code>polls/models.py</code>:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.db <span class=\"keyword\">import</span> models</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your models here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Question</span><span class=\"params\">(models.Model)</span>:</span></span><br><span class=\"line\">    question_text = models.CharField(max_length=<span class=\"number\">200</span>)</span><br><span class=\"line\">    pub_date = models.DateTimeField(<span class=\"string\">'date published'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Choice</span><span class=\"params\">(models.Model)</span>:</span></span><br><span class=\"line\">    question = models.ForeignKey(Question, on_delete=models.CASCADE)</span><br><span class=\"line\">    choice_text = models.CharField(max_length=<span class=\"number\">200</span>)</span><br><span class=\"line\">    votes = models.IntegerField(default=<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<p>接下来要让models生效。首先在settings.py中添加我们的polls应用，这样迁移的时候才会执行。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSTALLED_APPS = [</span><br><span class=\"line\">    <span class=\"string\">'polls.app.PollsConfig'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.admin'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.auth'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.contenttypes'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.sessions'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.messages'</span>,</span><br><span class=\"line\">    <span class=\"string\">'django.contrib.staticfiles'</span>,</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>然后执行命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py makemigrations polls</span><br><span class=\"line\">Migrations for 'polls':</span><br><span class=\"line\">  polls/migrations/0001_initial.py</span><br><span class=\"line\">    - Create model Choice</span><br><span class=\"line\">    - Create model Question</span><br><span class=\"line\">    - Add field question to choice</span><br></pre></td></tr></table></figure>\n<p>makemigrations命令的作用是告诉Django我对models做了一些改变，需要存到migration中去。可以在<code>polls/migrations/0001_initial.py</code>查看对应内容。这个文件是可以改动的，达到手动控制Django迁移结果的目的。现在执行迁移并修改库表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py migrate</span><br><span class=\"line\">Operations to perform:</span><br><span class=\"line\">  Apply all migrations: admin, auth, contenttypes, polls, sessions</span><br><span class=\"line\">Running migrations:</span><br><span class=\"line\">  Applying polls.0001_initial... OK</span><br></pre></td></tr></table></figure>\n<p>在MySQL中可以看到创建了两张表：polls_choice,  polls_question.</p>\n<p>使用迁移最大的好处是可以不用手动去修改库表，尤其是线上环境，可以在不影响现有业务的前提下更新库表。</p>\n<p>下面看看Django自带的admin管理端。</p>\n<p>首先创建管理员用户：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) myproj ❯ python manage.py createsuperuser</span><br></pre></td></tr></table></figure>\n<p>按提示输入用户名，邮箱和密码即可。</p>\n<p>然后在polls/admin.py中注册model - Question，告诉admin其可以在页面上被修改。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib <span class=\"keyword\">import</span> admin</span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Question, Choice</span><br><span class=\"line\"><span class=\"comment\"># Register your models here.</span></span><br><span class=\"line\"></span><br><span class=\"line\">admin.site.register(Question)</span><br></pre></td></tr></table></figure>\n<p>启动服务后，在<a href=\"http://localhost:8000/admin/\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/admin/</a> 页面可以看到Question已经可以编辑了。真的是太方便了！</p>\n","text":"今天要涉及的部分是数据库和模型，以及Django自带的admin管理端。Django支持很多常见的数据库，我这里选择用MySQL。要能让Django与MySQL交互，Django官方推荐安装mysqlclient–直接pip安装即可。数据库配置在myproj/settings.p","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Python","slug":"Python","count":4,"path":"api/tags/Python.json"},{"name":"Django","slug":"Django","count":3,"path":"api/tags/Django.json"}]},{"title":"beginner to Django 3","slug":"beginner-to-Django-3","date":"2018-11-16T10:25:38.000Z","updated":"2018-11-16T12:08:19.506Z","comments":true,"path":"api/articles/beginner-to-Django-3.json","excerpt":"","keywords":null,"cover":null,"content":"<p>接下来进入视图部分。</p>\n<p>在<code>polls/views.py</code>中创建几个view funcs:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your views here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">(request)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">'Hello Django!'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">detail</span><span class=\"params\">(request, question_id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">'You are looking at question %s'</span> % question_id)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">result</span><span class=\"params\">(request, question_id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">'You are looking at the result of question %s'</span> % question_id)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">vote</span><span class=\"params\">(request, question_id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">'You are voting on question %s'</span> % question_id)</span><br></pre></td></tr></table></figure>\n<p>然后在<code>polls/urls.py</code>中构建url到view func的映射：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> . <span class=\"keyword\">import</span> views</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">''</span>, views.index, name=<span class=\"string\">'index'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/'</span>, views.detail, name=<span class=\"string\">'detail'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/results/'</span>, views.result, name=<span class=\"string\">'results'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/vote/'</span>, views.vote, name=<span class=\"string\">'vote'</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>然后分别访问<a href=\"http://localhost:8000/polls/1/，\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/polls/1/，</a> <a href=\"http://localhost:8000/polls/1/results/\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/polls/1/results/</a>, <a href=\"http://localhost:8000/polls/1/vote/\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/polls/1/vote/</a>  就可以看到对应结果了。</p>\n<p>由于我们在<code>settings.py</code>中设置了<code>ROOT_URLCONF = &#39;myproj.urls&#39;</code>， 因此请求会首先找到<code>myproj/urls.py</code>,  在那里匹配到polls规则后，去掉这部分，转到<code>polls/urls.py</code>中来匹配，遍历<code>urlpatterns</code>中每一个path, 找到第一个匹配的path指定的view， 将request和对应参数传入，得到响应。所以path的顺序很重要。</p>\n<p>OK，流程上应该没问题了，让我们加上模板系统，上点真材实料！</p>\n<p>首先，在polls目录下创建一个子目录templates。这是因为settings.py中设置TEMPLATES的backend为DjangoTemplates， 同时其APP_DIRS也设为True，而DjangoTemplates会在每一个INSTALLED_APPS的目录下寻找templates的子目录。</p>\n<p>然后在templates下再创建一个polls的子目录。在其中新建index.html文件：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% if latest_question_list %&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ul</span>&gt;</span></span><br><span class=\"line\">    &#123;% for question in latest_question_list %&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/polls/&#123;&#123; question.id &#125;&#125;/\"</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\">    &#123;% endfor %&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">ul</span>&gt;</span></span><br><span class=\"line\">&#123;% else %&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>No polls are available.<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>\n<p>修改视图函数index:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.template <span class=\"keyword\">import</span> loader</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Question</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your views here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">(request)</span>:</span></span><br><span class=\"line\">    latest_question_list = Question.objects.order_by(<span class=\"string\">'-pub_date'</span>)[:<span class=\"number\">5</span>]</span><br><span class=\"line\">    template = loader.get_template(<span class=\"string\">'polls/index.html'</span>)</span><br><span class=\"line\">    context = &#123;</span><br><span class=\"line\">        <span class=\"string\">'latest_question_list'</span>: latest_question_list,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(template.render(context, request))</span><br></pre></td></tr></table></figure>\n<p>去<a href=\"http://localhost:8000/polls/\" target=\"_blank\" rel=\"noopener\">http://localhost:8000/polls/</a> 就可以看到最近创建的5个问题了。</p>\n<p>记不记得Flask渲染模板用的是render函数？没错，Django也有…</p>\n<p>改写后的index, 方便多了。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">(request)</span>:</span></span><br><span class=\"line\">    latest_question_list = Question.objects.order_by(<span class=\"string\">'-pub_date'</span>)[:<span class=\"number\">5</span>]</span><br><span class=\"line\">    context = &#123;</span><br><span class=\"line\">        <span class=\"string\">'latest_question_list'</span>: latest_question_list,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render(request, <span class=\"string\">'polls/index.html'</span>, context)</span><br></pre></td></tr></table></figure>\n<p>如果请求的资源不存在，需要返回404异常的话：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse, Http404</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Question</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your views here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">detail</span><span class=\"params\">(request, question_id)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        question = Question.objects.get(pk=question_id)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Question.DoesNotExist:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> Http404(<span class=\"string\">'Question donot exist.'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> render(request, <span class=\"string\">'polls/detail.html'</span>, &#123;<span class=\"string\">'question'</span>: question&#125;)</span><br></pre></td></tr></table></figure>\n<p>或者更快捷一点：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render, get_object_or_404</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Question</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create your views here.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">detail</span><span class=\"params\">(request, question_id)</span>:</span></span><br><span class=\"line\">    question = get_object_or_404(Question, pk=question_id)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render(request, <span class=\"string\">'polls/detail.html'</span>, &#123;<span class=\"string\">'question'</span>: question&#125;)</span><br></pre></td></tr></table></figure>\n<p>回到index视图，前面hardcode了一个地方：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/polls/&#123;&#123; question.id &#125;&#125;/\"</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这样很不好，一旦url规则要改，全部都要改，有一个类似于Flask的url_for的方法：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"&#123;% url 'detail' question.id %&#125;\"</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>能这么做的前提，是我们之前在配置url映射的时候，在path函数中设置了name 关键字参数：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">path(<span class=\"string\">'&lt;int:question_id&gt;/'</span>, views.detail, name=<span class=\"string\">'detail'</span>)</span><br></pre></td></tr></table></figure>\n<p>这样就不用担心url格式发生变化了。</p>\n<p>但是实际生产环境的项目可能会有很多的apps，可能其他app中也有一个detail的视图，那怎么区分呢？</p>\n<p>办法很简单，namespace–名称空间。</p>\n<p>添加应用的名称空间：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># polls/urls.py</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> . <span class=\"keyword\">import</span> views</span><br><span class=\"line\"></span><br><span class=\"line\">app_name = <span class=\"string\">'polls'</span></span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">''</span>, views.index, name=<span class=\"string\">'index'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/'</span>, views.detail, name=<span class=\"string\">'detail'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/results/'</span>, views.result, name=<span class=\"string\">'results'</span>),</span><br><span class=\"line\">    path(<span class=\"string\">'&lt;int:question_id&gt;/vote/'</span>, views.vote, name=<span class=\"string\">'vote'</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>修改链接：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"&#123;% url 'polls:detail' question.id %&#125;\"</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>启动服务，一切OK.</p>\n","text":"接下来进入视图部分。在polls/views.py中创建几个view funcs:1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Python","slug":"Python","count":4,"path":"api/tags/Python.json"},{"name":"Django","slug":"Django","count":3,"path":"api/tags/Django.json"}]}]}